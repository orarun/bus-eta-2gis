# Bus ETA 2GIS

Небольшой микросервис для определения примерного времени прибытия (ETA) ближайшего общественного транспорта до заданной точки на маршруте, используя данные от 2GIS.

## Описание

Я искал готовое API, чтобы получать время прибытия (ETA) ближайших автобусов или троллейбусов на мои остановки для интеграции с Home Assistant. Ни одно из официальных или неофициальных решений не оказалось достаточно подходящим или доступным в моем регионе. В результате, я создал этот микросервис самостоятельно.

Основная цель — получить простое числовое значение (или строку, если транспорт далеко или отсутствует), которое можно отобразить в виде виджета в Home Assistant и использовать, например, чтобы знать, когда выходить из дома.

Данные получаются из публичного (неофициального) API 2GIS. 2GIS предоставляет JSON-ответы без необходимости авторизации. Эндпоинт `/v2/points/directions` возвращает данные о местоположении и скорости транспорта в реальном времени. Эти данные анализируются для нахождения транспорта, следующего по нужному маршруту в нужном направлении, и расчета времени его прибытия до заданной точки (`stop_part`).

> [!NOTE]
> Сервис работает в любом городе, где 2GIS отображает транспорт.

Точность расчета сравнима с официальными приложениями и веб-интерфейсом 2GIS. Однако, этот сервис предоставляет более стабильное числовое значение ETA, без визуальных "глюков", характерных для графических интерфейсов (прыжки транспорта, мерцание, исчезновение с карты). Это достигается за счет постоянного расчета на основе геометрии маршрута и фиксированной средней скорости, а также встроенной логики обработки отсутствия данных (счетчик пропусков).

---

## Принцип работы

1.  **Запрос:** Home Assistant (через `rest`-сенсор) отправляет GET-запрос к этому сервису с параметрами: `route_name`, `direction_id`, `stop_part`.
2.  **Кеширование:** Сервис кеширует ответ от 2GIS на короткое время (например, 15 секунд), чтобы не перегружать внешний API.
3.  **Поиск и расчет:** Из закешированных данных извлекаются устройства (транспорт), соответствующие `route_name` и `direction_id`. Для каждого подходящего устройства рассчитывается пройденная дистанция (`direction_length * geometry_way_part`) и расстояние до целевой остановки (`direction_length * stop_part`). Если транспорт еще не дошел до остановки, рассчитывается ETA на основе оставшегося расстояния и средней скорости (`AVG_SPEED`).
4.  **Выбор минимального:** Из всех рассчитанных ETAs выбирается минимальное.
5.  **Фильтрация и форматирование:** Если минимальное ETA превышает заданный лимит (`ETA_LIMIT`), или подходящих транспортных средств не найдено (и счетчик пропусков превысил `MISS_LIMIT`), возвращается специальное значение (например, строка `">Xм"` или `null`).
6.  **Ответ:** Сервис возвращает JSON-объект `{"eta": ...}`, где `...` — это число (в секундах или минутах, в зависимости от параметра `unit`) или строка. Если указан параметр `return_all_sorted`, то возвращается массив чисел.

---

## Установка и запуск

### Требования

- Docker
- Docker Compose

### Шаги

1.  Склонируйте репозиторий (или создайте структуру файлов вручную).
2.  Убедитесь, что у вас есть файлы `Dockerfile`, `app/app.py`, и `docker-compose.yml` (пример см. ниже).
3.  Отредактируйте `docker-compose.yml`, указав корректные `DIRECTIONS`, `STOP_PART`, `ROUTE`, `AVG_SPEED`, `ETA_LIMIT` и другие переменные окружения по необходимости.
4.  Откройте терминал в директории, где находится `docker-compose.yml`.
5.  Выполните команду:
    ```bash
    docker-compose up -d
    ```
    Это соберет образ и запустит контейнер в фоновом режиме.

---

## Конфигурация (Docker Compose)

Пример `docker-compose.yml`:

```yaml
version: '3.8'
services:
  bus-eta-2gis:
    build: . # Предполагает наличие Dockerfile в корне
    image: bus-eta-2gis # Имя собранного образа
    container_name: bus-eta-2gis
    restart: unless-stopped
    environment:
      # --- Параметры API 2GIS ---
      DGS_URL: https://eta.api.2gis.ru/v2/points/directions
      
      # --- Параметры расчета и поведения ---
      # Средняя скорость транспорта в км/ч (используется для расчета ETA)
      AVG_SPEED: 26
      # Максимальное ETA в *МИНУТАХ*, которое возвращается. Если рассчитанное ETA больше, возвращается строка ">Xм".
      ETA_LIMIT: 30
      # Количество последовательных неудачных проверок (нет подходящих транспортов), после которых сервис возвращает null.
      # Это помогает отличить кратковременное отсутствие транспорта от сбоя получения данных.
      MISS_LIMIT: 5
      # Интервал между запросами к 2GIS API в секундах (для кеширования).
      POLL_INTERVAL: 15
    ports:
      - "8000:8000" # Порт, на котором слушает сервис внутри контейнера
```

---

## Использование

### Запрос к сервису

Сервис предоставляет GET-эндпоинт `/eta`.

```bash
GET http://<SERVER_IP>:8000/eta?route_name=<ROUTE_NAME>&direction_id=<DIRECTION_ID>&stop_part=<STOP_PART>&unit=<UNIT_TYPE>&return_all_sorted=<BOOLEAN>
```

Параметры:

- `SERVER_IP`: IP-адрес машины, на которой запущен контейнер.
- `route_name` (string, required): Номер маршрута (например, `"11"`, `"168A"`).
- `direction_id` (string, required): Уникальный идентификатор направления движения маршрута. Обычно их два: туда и обратно.
- `stop_part` (float, required): Доля пути от начала маршрута до нужной точки (остановки). Диапазон от `0.0` до `1.0`. Определяется экспериментально.
- `unit` (string, optional, default="min"): Единицы измерения для возвращаемого ETA. Возможные значения: `"min"` (минуты) или `"sec"` (секунды).
- `return_all_sorted` (boolean, optional): Возвращает массив чисел, представляющих собой времена прибытия последующих автобусов. 


> [!TIP]
> Как определить direction_id и stop_part?
> 
> Зайдите на сайт 2GIS и найдите нужный маршрут.
> Откройте Network (Сеть) в Developer Tools браузера.
> Найдите запрос к /v2/points/directions (или похожему эндпоинту).
> Посмотрите тело запроса (Request Payload) — там будут directions. Это и есть > direction_id.
> Посмотрите ответ (Response) — найдите устройства (devices), соответствующие вашему маршруту.
> Наблюдайте за geometry_way_part устройства, движущегося в нужном направлении, пока оно не дойдет до вашей остановки. Значение geometry_way_part в этот момент — это ваш stop_part.

Пример запроса:

```bash
curl "http://<SERVER_IP>:8000/eta?route_name=168&direction_id=4504746941846382&stop_part=0.4440&unit=min&return_all_sorted=true"
```

Примеры ответов:

- `{"eta": 5}` — Транспорт придет примерно через 5 минут.
- `{"eta": 123}` — Транспорт придет примерно через 123 секунды.
- `{"eta": ">30м"}` — Ближайший транспорт придет позже 30 минут (лимит).
- `{"eta": null}` — Подходящий транспорт не найден или превышен `MISS_LIMIT`.
- `{"etas":[9, 22]}` - Транспорт придет примерно через 9 минут, следующий через 22 минуты.

---

## Интеграция с Home Assistant

### 1. Конфигурация `configuration.yaml`

Добавьте следующие блоки в ваш `configuration.yaml`:

```yaml
rest:
  - resource: "http://SERVER:8000/eta?route_name=168&direction_id=4504746941846382&stop_part=0.4440&unit=min"
    method: GET
    scan_interval: 15 # Должно соответствовать POLL_INTERVAL или быть чуть больше
    sensor:
      - name: "Bus 168 ETA Raw"
        unique_id: bus_168_eta_raw_min_v2
        value_template: "{{ value_json.eta }}"
        json_attributes_path: "$"
        json_attributes:
          - eta

template:
  - sensor:
      - name: "Автобус 168 — ETA (мин)"
        unique_id: bus_168_eta_display_min_v2
        state: "{{ states('sensor.bus_168_eta_raw_min_v2') }}"
        attributes:
          raw_eta_value: "{{ state_attr('sensor.bus_168_eta_raw_min_v2', 'eta') }}"
          last_updated_rest: "{{ state_attr('sensor.bus_168_eta_raw_min_v2', 'last_updated_rest') | default(now()) }}"
```

Или для нескольких автобусов:

```yaml
rest:
  - resource: "http://SERVER:8000/eta?route_name=168&direction_id=4504746941846382&stop_part=0.4440&unit=min&return_all_sorted=true"
    method: GET
    scan_interval: 15 # Должно соответствовать POLL_INTERVAL или быть чуть больше
    sensor:
      - name: "Автобус 168:"
        unique_id: bus_168_etas_raw_min_v2
        value_template: >
          {% if value_json.etas and value_json.etas | length > 0 %}
            {{ value_json.etas }}
          {% else %}
            -
          {% endif %}
        json_attributes_path: "$"
        json_attributes:
          - etas
```

> [!IMPORTANT]
> Замените 168, 4504746941846382, 0.4440 на свои значения.

### 2. Конфигурация Lovelace Dashboard (например, `tablet-dashboard.yaml`)

```yaml
views:
  - title: Транспорт
    cards:
      - type: entities
        title: Автобус 168
        entities:
          - entity: sensor.автобус_168_ета_min
            name: Прибытие (мин)
  - title: Home
    path: home
    cards:
      - type: weather-forecast
        entity: weather.home
```

---

### Замечания

- Нет валидации входных данных: Если `route_name`, `direction_id` или `stop_part` указаны неверно, сервис не сможет найти подходящий транспорт и будет использовать логику `miss_count` или возвращать строку `">Xм"` (если `miss_count < MISS_LIMIT`).
- Средняя скорость (`AVG_SPEED`): Это приближенное значение. Реальная скорость может сильно варьироваться в зависимости от пробок, светофоров, погоды и т.д. Точность ETA зависит от этого параметра.
- Счетчик пропусков (`MISS_LIMIT`): Полезен для стабильности. Если подходящий транспорт действительно долго не появляется (например, вечером или маршрут отменен), после 5 неудачных попыток сенсор в HA станет `unavailable`. Как только транспорт появится, счетчик сбросится.
- Кеширование: Важно, чтобы `scan_interval` в `rest`-сенсоре HA был равен или немного больше `POLL_INTERVAL` в `docker-compose.yml`, чтобы избежать лишних обращений к 2GIS API.