# bus-eta-2gis
Небольшой api определения ETA от конечной до определенной точки на маршруте через сервис 2GIS

Искал какой либо API чтобы рассчитывать время прибытия (ETA) ближайшего автобуса нужных мне маршрутов на мою остановку для использования в виджете Home Assistant. Ничего толкового так и не смог найти. Пришлось делать самому. Мне нужно было получить просто время через которое автобус придет на остановку, чтобы знать когда выходить из дома.

Данные решил брать от 2GIS. Он удобен тем, что отдает JSON без авторизации. Через Developer Tools браузера нашел эндпоинт по которому можно запрашивать данные. Для этого зашел на страницу (https://2gis.com)[2GIS], вбил в поиске номер нужного автобуса в своем городе, далее в Developer Tools смотел что приходит по эндпоинту **/directions**. Немного пришлось разобраться в назначении параметров, но там все оказалось просто. Сервис работает по любому городу, где 2GIS отображает транспорт.

Путем некоторых проб и ошибок пришел к тому что проще всего взять среднюю скорость автобуса на маршруте и рассчитывать ETA исходя из оставшейся длины пути до нужной остановки. Данные у 2GIS обновляются каджые 5 сек. Я решил что мне так часто не нужно, поэтому опрашиваю каждые 15 сек. Точность оказалось такой же как в приложениях 2GIS, Bustime и go2bus. Но в этих приложениях (включая сам 2GIS) часто с интерфейсом или графикой происходят какие то глюки, из-за чего автобусы то появляются на карте, то исчезают, то внезапно перепрыгивают на несколько остановок вперед или назад. Мой же сервис стабильно показывает время прибытия на нужную мне остановку, которое все время только уменьшается, за счет того что я считаю автобус потерянным только после 5 неудачных попыток получения данных.

Для получения ETA нужно отправить запрос вида:

```bash
"http://SERVER_IP:8000/eta?route_name=<ROUTE_NAME>&direction_id=<DIRECTION_ID>&stop_part=<STOP_PART>&unit=<TYPE>"
```

где:
SERVER_IP - IP адрес сервера, где запущен сервис;
ROUTE_NAME - номер маршрута автобуса;
DIRECTION_ID - направление;
STOP_PART - остановка на маршруте или любая интересующая точка пути;
TYPE - единица отображения, **мин** или **сек**.

В основном из названия параметров все ясно, немного пояснений дам только по двум.
DIRECTION_ID. Их обычно два, соответственно в одну и другую сторону. Нужный мне я определяю эксперементальным путем.
STOP_PART - точка до которой рассчитывать ETA. Тоже определяю эксперементальным путем. Нахожу автобус движущийся в нужном направлении, определяю его в приходящих данных, смотрю когда он доедет до нужной остановки и беру его **geometry_way_part**. Понять что автобус остановился можно по его скорости (будет 2-3км/ч) и geometry_way_part у него 5-10 сек не меняется. Параметр geometry_way_part меняется от 0 до 1, взависимости от пройденного по маршруту пути.

Примет реального запроса:

```bash
curl "http://SERVER:8000/eta?route_name=168&direction_id=4504746941846382&stop_part=0.4440&unit=min"
```

Есть небольшой момент, который нужно учитывать. Если данные в запросе указаны неверно, то микросервис уходит в fallback и возвращает дежурное ожидание ">30m". Валидации данных никакой нет, то есть сервис просто не находит автобуса по этим данным и выдает дежурное ожидание.